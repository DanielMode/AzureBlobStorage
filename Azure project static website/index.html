<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Azure Blob Storage Upload and List Files</title>
    <script src="https://cdn.jsdelivr.net/npm/@azure/storage-blob@12.15.0/dist/index.min.js"></script>
</head>
<body>

    <h1>Upload File to Azure Blob Storage</h1>

    <label for="sasToken">SAS Token:</label>
    <input type="text" id="sasToken" placeholder="Enter SAS token" />

    <h2>Upload File</h2>
    <input type="file" id="fileInput" />
    <button id="uploadButton">Upload File</button>

    <h2>Stored Documents</h2>
    <div id="fileList"></div>

    <script>
        // Global variables
        let blobServiceClient;
        const containerName = 'documents';

        // Initialize the BlobServiceClient using SAS Token
        function initialize(sasToken) {
            console.log("SAS Token Entered:", sasToken);  // Check what is captured
            if (!sasToken.startsWith('sp=')) {
                alert('Please enter a valid SAS token');
                return;
            }
            blobServiceClient = new Azure.Storage.BlobServiceClient(
                `https://diseper.blob.core.windows.net?${sasToken}`
            );
            console.log("BlobServiceClient initialized.");
        }

        // Upload a file to the container
        async function uploadFile() {
            const sasToken = document.getElementById('sasToken').value.trim();
            console.log("Captured SAS Token in uploadFile():", sasToken);  // Debugging the SAS Token
            if (!sasToken) {
                alert('Please enter a valid SAS token');
                return;
            }
            initialize(sasToken); // Initialize only if SAS token is valid

            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            if (!file) {
                alert('Please select a file');
                return;
            }

            const containerClient = blobServiceClient.getContainerClient(containerName);
            const blockBlobClient = containerClient.getBlockBlobClient(file.name);

            try {
                const uploadBlobResponse = await blockBlobClient.uploadBrowserData(file);
                alert('File uploaded successfully!');
                listFiles();
            } catch (error) {
                alert('Error uploading file: ' + error.message);
            }
        }

        // List files in the container
        async function listFiles() {
            if (!blobServiceClient) {
                alert('Please connect first using your SAS token');
                return;
            }

            const containerClient = blobServiceClient.getContainerClient(containerName);
            let fileList = '';

            try {
                for await (const blob of containerClient.listBlobsFlat()) {
                    fileList += `
                        <div>
                            <span>${blob.name}</span>
                            <button onclick="downloadFile('${blob.name}')">Download</button>
                            <button onclick="deleteFile('${blob.name}')">Delete</button>
                        </div>
                    `;
                }
                document.getElementById('fileList').innerHTML = fileList;
            } catch (error) {
                alert('Error listing files: ' + error.message);
            }
        }

        // Download a file
        async function downloadFile(blobName) {
            if (!blobServiceClient) {
                alert('Please connect first using your SAS token');
                return;
            }

            const containerClient = blobServiceClient.getContainerClient(containerName);
            const blockBlobClient = containerClient.getBlockBlobClient(blobName);

            try {
                const downloadBlockBlobResponse = await blockBlobClient.download();
                const downloadedData = await streamToText(downloadBlockBlobResponse.readableStreamBody);
                const blob = new Blob([downloadedData], { type: 'application/octet-stream' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = blobName;
                a.click();
                window.URL.revokeObjectURL(url);
            } catch (error) {
                alert('Error downloading file: ' + error.message);
            }
        }

        // Delete a file
        async function deleteFile(blobName) {
            if (!blobServiceClient) {
                alert('Please connect first using your SAS token');
                return;
            }

            const containerClient = blobServiceClient.getContainerClient(containerName);
            const blockBlobClient = containerClient.getBlockBlobClient(blobName);

            try {
                await blockBlobClient.delete();
                alert('File deleted successfully!');
                listFiles();
            } catch (error) {
                alert('Error deleting file: ' + error.message);
            }
        }

        // Helper function to convert stream to text
        async function streamToText(stream) {
            const reader = stream.getReader();
            let text = '';
            const decoder = new TextDecoder();
            let done, value;
            while (!done) {
                ({ done, value } = await reader.read());
                text += decoder.decode(value, { stream: true });
            }
            text += decoder.decode();
            return text;
        }

        // Add event listener to upload button
        document.getElementById('uploadButton').addEventListener('click', uploadFile);

        // Load files on page load
        window.onload = listFiles;
    </script>

</body>
</html>
