<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Azure Blob Storage Upload and List Files</title>
    <!-- Using the latest Azure SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@azure/storage-blob@12.17.0/dist/index.min.js"></script>
</head>
<body>

    <h1>Upload File to Azure Blob Storage</h1>

    <label for="sasToken">SAS Token:</label>
    <input type="text" id="sasToken" placeholder="Enter SAS token" />
    <button id="connectButton">Connect</button>

    <h2>Upload File</h2>
    <input type="file" id="fileInput" />
    <button id="uploadButton">Upload File</button>

    <h2>Stored Documents</h2>
    <div id="fileList"></div>

    <script>
        // Global variables
        let blobServiceClient;
        const containerName = 'documents';
        const accountName = 'diseper'; // Your storage account name

        // Initialize the BlobServiceClient using SAS Token
        function initialize() {
            const sasToken = document.getElementById('sasToken').value.trim();
            console.log("SAS Token Entered:", sasToken);

            if (!sasToken) {
                alert('Please enter a valid SAS token');
                return;
            }

            try {
                blobServiceClient = new BlobServiceClient(
                    `https://${accountName}.blob.core.windows.net?${sasToken}`
                );
                console.log("BlobServiceClient initialized.");
                listFiles(); // Only list files after successful connection
            } catch (error) {
                alert('Error initializing blob service: ' + error.message);
            }
        }

        // Upload a file to the container
        async function uploadFile() {
            if (!blobServiceClient) {
                alert('Please connect first using your SAS token');
                return;
            }

            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            if (!file) {
                alert('Please select a file');
                return;
            }

            try {
                const containerClient = blobServiceClient.getContainerClient(containerName);
                const blockBlobClient = containerClient.getBlockBlobClient(file.name);
                const response = await blockBlobClient.uploadBrowserData(file, {
                    onProgress: ev => console.log(`Uploaded ${ev.loadedBytes} bytes`)
                });
                alert('File uploaded successfully!');
                listFiles();
            } catch (error) {
                alert('Error uploading file: ' + error.message);
            }
        }

        // List files in the container
        async function listFiles() {
            if (!blobServiceClient) {
                console.log('Blob service not initialized');
                return;
            }

            try {
                const containerClient = blobServiceClient.getContainerClient(containerName);
                let fileList = '';

                for await (const blob of containerClient.listBlobsFlat()) {
                    fileList += `
                        <div>
                            <span>${blob.name}</span>
                            <button onclick="downloadFile('${blob.name}')">Download</button>
                            <button onclick="deleteFile('${blob.name}')">Delete</button>
                        </div>
                    `;
                }
                document.getElementById('fileList').innerHTML = fileList;
            } catch (error) {
                alert('Error listing files: ' + error.message);
            }
        }

        // Download a file
        async function downloadFile(blobName) {
            if (!blobServiceClient) {
                alert('Please connect first using your SAS token');
                return;
            }

            try {
                const containerClient = blobServiceClient.getContainerClient(containerName);
                const blobClient = containerClient.getBlobClient(blobName);
                const response = await blobClient.download();
                const blob = await response.blobBody;
                
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = blobName;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } catch (error) {
                alert('Error downloading file: ' + error.message);
            }
        }

        // Delete a file
        async function deleteFile(blobName) {
            if (!blobServiceClient) {
                alert('Please connect first using your SAS token');
                return;
            }

            try {
                const containerClient = blobServiceClient.getContainerClient(containerName);
                const blockBlobClient = containerClient.getBlockBlobClient(blobName);
                await blockBlobClient.delete();
                alert('File deleted successfully!');
                listFiles();
            } catch (error) {
                alert('Error deleting file: ' + error.message);
            }
        }

        // Add event listeners
        document.getElementById('connectButton').addEventListener('click', initialize);
        document.getElementById('uploadButton').addEventListener('click', uploadFile);
    </script>

</body>
</html>
